<!DOCTYPE html>
    <html>
      <head>
        <!-- faigelabs - test code for Floid maps - cfaigle - free -->
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <style type="text/css">
          html { height: 100% }
          body { height: 100%; margin: 0; padding: 0 }
          #map_canvas { height: 100% }
        </style>
        <script type ="text/javascript"
                src  ="FloidMapUtilities.js">
        </script>
        <script type ="text/javascript"
                src  ="jquery-1.9.1.min.js">
        </script>
        <script type ="text/javascript"
                src  ="http://www.mapquestapi.com/sdk/js/v7.0.s/mqa.toolkit.js?key=YOUR_API_KEY">
        </script> 
        <script type="text/javascript">
            ///////////////////////////////////////////
            ///////////////////////////////////////////
            // Main Initialize - Magic starts here:  //
            ///////////////////////////////////////////
            ///////////////////////////////////////////             
            function initialize()
            {
                // Could not get the listener to remove so we will just keep a flag:
                var doubleClickable = false;
                function mapDoubleClickListener(event)
                {
                    if(doubleClickable)
                    {
                        mapDoubleClick(event.ll);
                    }
                };
                //----------------------------------//
                // Create the default map options:  //
                //----------------------------------//
                var mapOptions =  {
                                    elt                     : document.getElementById('map_canvas'),
                                    zoom                    : 12,
                                    latLng                  : { lat:latStart, lng: lngStart },
                                    mtype                   : 'map',
                                    bestFitMargin           : 0,
                                    zoomOnDoubleClick       : false
                                  };
                //---------------------------------------//
                // Create the map and elevator service:  //
                //---------------------------------------//
                var map           = new MQA.TileMap(mapOptions);
                MQA.withModule('largezoom',
                               'viewoptions',
                               'mousewheel',
                               'traffictoggle',
                               'viewoptions',
                               'geolocationcontrol',
                               'insetmapcontrol',
                               function()
                               {
                                  map.addControl(new MQA.ViewOptions());
                                  map.addControl(new MQA.LargeZoom(), new MQA.MapCornerPlacement(MQA.MapCorner.TOP_LEFT, new MQA.Size(5,5)));
                                  map.enableMouseWheelZoom();
                               });
                //----------------------------------------------//
                // By default we add the double click listener: //
                //----------------------------------------------//
                // In mapQuest we add it one time and then turn it on:
                MQA.EventManager.addListener(map, 'doubleclick', mapDoubleClickListener);
                addDoubleClickListener();
                //-------------------------------------------------------//
                // Make add and remove map double click event listeners: //
                //-------------------------------------------------------//
                function addDoubleClickListener()
                {
                    log("addDoubleClickListener: " + mapId);
                    doubleClickable = true;
                }
                function removeDoubleClickListener()
                {
                    log("removeDoubleClickListener: " + mapId);
                    doubleClickable = false;
                }
                //------------------------------------------//
                // Create handlers for map double click:    //
                //------------------------------------------//
                // mapDoubleClick:
                function mapDoubleClick(latLng)
                {
                    log("mapDoubleClick: " + latLng);
                    log("calling flash routine: " + "floidMapDoubleClick_" + mapId);
                    swfObject["floidMapDoubleClick_" + mapId](latLng.lat, latLng.lng);
                }
                //********************************//
                //********************************//
                // Calls from Flash to the map:   //
                //********************************//
                //********************************//
                ////////////////////////////////////////////////
                // Function creators for flash calls to map:  //
                ////////////////////////////////////////////////
                // ---------------------------------
                // floidMapQuestMapsCreateNewMarker:
                // ---------------------------------
                function makeFloidMapQuestMapsCreateNewMarkerFunction()
                {
                    return function(lat, lng, markerId)
                    {
                        log("floidMapQuestMapsCreateNewMarker: " + lat + " " + lng + " " + markerId);
                        createNewMarker(lat, lng, markerId);
                    } 
                }
                // -------------------------------
                // floidMapQuestMapsCreateNewLine:
                // -------------------------------
                function makeFloidMapQuestMapsCreateNewLineFunction()
                {
                    return function(lineId, startLat, startLng, endLat, endLng, a, r, g, b, w)
                    {
                        log("floidMapQuestMapsCreateNewLine: " + startLat + " " + startLng + " " + endLat + " " + endLng + " " + a + " " + r + " " + g + " " + b);
                        createNewLine(lineId, startLat, startLng, endLat, endLng, a, r, g, b, w);
                    }
                }
                // ----------------------------------------
                // floidMapQuestMapsAddDoubleClickListener:
                // ----------------------------------------
                function makeFloidMapQuestMapsAddDoubleClickListenerFunction()
                {
                    return function(mapId)
                    {
                        log("floidMapQuestMapsAddDoubleClickListener: " + mapId);
                        addDoubleClickListener();
                    } 
                }
                // -------------------------------------------
                // floidMapQuestMapsRemoveDoubleClickListener:
                // -------------------------------------------
                function makeFloidMapQuestMapsRemoveDoubleClickListenerFunction()
                {
                    return function(mapId)
                    {
                        log("floidMapQuestMapsRemoveDoubleClickListener: " + mapId);
                        removeDoubleClickListener();
                    } 
                }
                // ----------------------------------
                // floidMapQuestMapsGetPathMaxElevation:
                // ----------------------------------
                function makeFloidMapQuestMapsGetPathMaxElevationFunction()
                {
                    return function(lineId, startLat, startLng, endLat, endLng, maxMarkers, requestedPathDistanceInMeters, errorElevation, warningElevation, actualMarkers, actualPathDistanceInMeters)
                    {
                        log("floidMapQuestMapsGetPathMaxElevation: " + startLat + " " + startLng + " " + endLat + " " + endLng + " " + maxMarkers + " " + requestedPathDistanceInMeters + " " + errorElevation + " " + warningElevation + " " + actualMarkers + " " + actualPathDistanceInMeters);
                        getPathMaxElevation(lineId, startLat, startLng, endLat, endLng, maxMarkers, requestedPathDistanceInMeters, errorElevation, warningElevation, actualMarkers, actualPathDistanceInMeters);
                    } 
                }
                //////////////////////////////////////////////////////////////////////////////
                // Make a set of function creation routines for the flash calls to the DOM: //
                //////////////////////////////////////////////////////////////////////////////
                // ----------------------------------
                // floidMapQuestMapsCreateNewMarker:
                // ----------------------------------
                var floidMapQuestMapsCreateNewMarkerFunctionName                       = "floidMapCreateNewMarker_" + mapId;
                this.parent[floidMapQuestMapsCreateNewMarkerFunctionName]              = makeFloidMapQuestMapsCreateNewMarkerFunction();
                // --------------------------------
                // floidMapQuestMapsCreateNewLine:
                // --------------------------------
                var floidMapQuestMapsCreateNewLineFunctionName                         = "floidMapCreateNewLine_" + mapId;
                this.parent[floidMapQuestMapsCreateNewLineFunctionName]                = makeFloidMapQuestMapsCreateNewLineFunction();
                // -----------------------------------------
                // floidMapQuestMapsAddDoubleClickListener:
                // -----------------------------------------
                var floidMapQuestMapsAddDoubleClickListenerFunctionName                = "floidMapAddDoubleClickListener_" + mapId;
                this.parent[floidMapQuestMapsAddDoubleClickListenerFunctionName]       = makeFloidMapQuestMapsAddDoubleClickListenerFunction();
                // --------------------------------------------
                // floidMapQuestMapsRemoveDoubleClickListener:
                // --------------------------------------------
                var floidMapQuestMapsRemoveDoubleClickListenerFunctionName             = "floidMapRemoveDoubleClickListener_" + mapId;
                this.parent[floidMapQuestMapsRemoveDoubleClickListenerFunctionName]    = makeFloidMapQuestMapsRemoveDoubleClickListenerFunction();
                // --------------------------------
                // floidMapQuestMapsGetPathMaxElevation:
                // --------------------------------
                var floidMapQuestMapsGetPathMaxElevationFunctionName                   = "floidMapGetPathMaxElevation_" + mapId;
                this.parent[floidMapQuestMapsGetPathMaxElevationFunctionName]          = makeFloidMapQuestMapsGetPathMaxElevationFunction();
                /////////////////////////////
                // Map routines:           //
                /////////////////////////////
                // We have to store the marker listeners & clickable state:
                var markerDoubleClickListener = null;
                var markerDragStartListener   = null;
                var markerDragEndListener     = null;
                var markerDragListener        = null;
                var clickable                 = true;
                // ----- MARKERS -----
                // ----------------
                // createNewMarker:
                // ----------------
                function createNewMarker(lat, lng, markerId)
                {
                    var marker       = new MQA.Poi({lat: lat, lng: lng});
                    log("Making new marker [" + mapId + "] ("+lat + ", " + lng + ")");
                    marker.draggable = true;
                    map.addShape(marker);
                    ////////////////////////////////////////////////
                    // Marker listeners that call back to flash:  //
                    ////////////////////////////////////////////////
                    // ------------------------------------------------------
                    // OK, here we want to add the listeners for this marker:
                    // ------------------------------------------------------
                    markerDoubleClickListener = function()
                                                {
                                                    if(clickable)
                                                    {
                                                        swfObject["floidMapMarkerDoubleClick_" + mapId+"_"+markerId](markerId);
                                                    }
                                                };
                    MQA.EventManager.addListener(marker, 'dblclick', markerDoubleClickListener);  // NOTE: dblclick v doubleclick - THIS IS DIFFERENT BETWEEN MAPS AND POI'S
    
                    markerDragStartListener   = function(event)
                                                { 
                                                    swfObject["floidMapMarkerDragStart_" + mapId+"_"+markerId](markerId, event.srcObject.latLng.lat, event.srcObject.latLng.lng);
                                                };
                    MQA.EventManager.addListener(marker, 'dragstart', markerDragStartListener);
                    markerDragEndListener     = function(event)
                                                {
                                                    swfObject["floidMapMarkerDragEnd_" + mapId+"_"+markerId](markerId, event.srcObject.latLng.lat, event.srcObject.latLng.lng);
                                                };
                    MQA.EventManager.addListener(marker, 'dragend', markerDragEndListener);
                    markerDragListener        = function(event)
                                                {
                                                    swfObject["floidMapMarkerDrag_" + mapId+"_"+markerId](markerId, event.srcObject.latLng.lat, event.srcObject.latLng.lng);
                                                };
                    MQA.EventManager.addListener(marker, 'drag', markerDragListener);
                    //***********************************//
                    //***********************************//
                    // Calls from Flash to the marker:   //
                    //***********************************//
                    //***********************************//
                    ///////////////////////////////////////////////////
                    // Function creators for flash calls to marker:  //
                    ///////////////////////////////////////////////////
                    // -------------------------------------------------------
                    // floidMapQuestMapsMarkerSetClickable: [function creator]
                    // -------------------------------------------------------
                    function makeFloidMapQuestMapsMarkerSetClickableFunction(marker, markerId)
                    {
                        return function(isClickable)
                        {
                            clickable = isClickable;
                        }
                    }
                    // -------------------------------------------------------
                    // floidMapQuestMapsMarkerSetDraggable: [function creator]
                    // -------------------------------------------------------
                    function makeFloidMapQuestMapsMarkerSetDraggableFunction(marker, markerId)
                    {
                        return function(draggable)
                        {
                            marker.setDraggable(draggable);
                        }
                    }
                    // --------------------------------------------------------
                    // floidMapQuestMapsMarkerSetIconString: [function creator]
                    // --------------------------------------------------------
                    function makeFloidMapQuestMapsMarkerSetIconStringFunction(marker, markerId)
                    {
                        return function(iconString)
                        {
                                log("floidMapQuestMapsMarkerSetIconString: " + markerId);
                                log("marker icon string: " + iconString);
                                marker.setIcon(new MQA.Icon('data:image/png;base64,'+iconString, 100, 38));
                                marker.setIconOffset(new MQA.Point(0,-38));
                                log("floidMapQuestMapsMarkerSetIconString: " + markerId + " - markerIconSet");
                        }
                    }
                    // --------------------------------------------------------------
                    // floidMapQuestMapsMarkerSetIconShadowString: [function creator]
                    // --------------------------------------------------------------
                    function makeFloidMapQuestMapsMarkerSetIconShadowStringFunction(marker, markerId)
                    {
                        return function(iconShadowString)
                        {
                                log("floidMapQuestMapsMarkerSetIconShadowString: " + markerId);
                                log("marker shadow string: " + iconShadowString);
                                log("floidMapQuestMapsMarkerSetIconString: " + markerId);
                                log("marker icon shadow string: " + iconShadowString);
                                marker.setShadow(new MQA.Icon('data:image/png;base64,'+iconShadowString, 132, 20));
                                log("floidMapQuestMapsMarkerSetIconString: " + markerId + " - markerIconSet");
                                marker.setShadowOffset(new MQA.Point(0,-20));
                                log("floidMapQuestMapsMarkerSetIconString: " + markerId + " - markerIconShadowSet");
                        }
                    }
                    // -----------------------------------------------------------
                    // floidMapQuestMapsMarkerRequestElevation: [function creator]
                    // -----------------------------------------------------------
                    function makeFloidMapQuestMapsMarkerRequestElevationFunction(marker, markerId)
                    {
                        return function(markerId, lat, lng)
                        {
                            // Build the url string:
                            // OK, make an array of sample points to test, but with only one point:
                            var sampleLocations = [lat, lng];
                            // Make elevation request object:
                            var elevationRequestObject = {
                                                             'unit'            : 'm',
                                                             'latLngCollection': sampleLocations
                                                         };
                            // Convert to JSON:
                            var elevationRequestJSONString = JSON.stringify(elevationRequestObject);
                            log("Elevation JSON String: " + elevationRequestJSONString);
                            var mapQuestElevationUrl = "http://open.mapquestapi.com/elevation/v1/profile?outFormat=json&json="+elevationRequestJSONString+"&callback=?";
                            $.ajax({
                                       url:        mapQuestElevationUrl,
                                       dataType:   'json',
                                       type:       'GET',
                                       contentType:'json',
                                       crossDomain:true,
                                       success:    function(data) {
                                                                      log( data );
                                                                      if(data.elevationProfile.length >0)
                                                                      {
                                                                          var elevation = data.elevationProfile[0].height;
                                                                          errorFlag  = false;
                                                                          log("Elevation of point: " + elevation);
                                                                          // call back into flash :)
                                                                          swfObject["floidMapMarkerElevationResult_" + mapId+"_"+markerId](markerId, elevation);
                                                                          log("elevation callback done:");
                                                                      }
                                                                  },
                                       error:      function(data) {
                                                                    log( 'error occurred - ' + data );
                                                                  }
                                   });
                            log("floidMapQuestMapsMarkerRequestElevation: " + markerId + " - Elevation Requested");
                        }
                    }
                    // -------------------------------------------------
                    // floidMapQuestMapsRemoveMarker: [function creator]
                    // -------------------------------------------------
                    function makeFloidMapQuestMapsRemoveMarkerFunction(marker, markerId)
                    {
                        return function()
                        {
                            log("Removing marker.");
                            try
                            {
                                // Remove the marker:
                                map.removeShape(marker);
                                marker = null;
                                // Remove the globally bound functions:
                                delete this.parent[floidMapQuestMapsMarkerSetClickableFunctionName];
                                delete this.parent[floidMapQuestMapsMarkerSetDraggableFunctionName];
                                delete this.parent[floidMapQuestMapsMarkerRequestElevationFunctionName];
                                delete this.parent[floidMapQuestMapsMarkerSetIconStringFunctionName];
                                delete this.parent[floidMapQuestMapsMarkerSetIconShadowStringFunctionName];
                                // Don't forget me!
                                delete this.parent[floidMapQuestMapsRemoveMarkerFunctionName];
                            }
                            catch(err)
                            {
                                log("floidMapQuestMapsRemoveMarker: error " + err);
                            }
                            log("Done removing marker.");
                        }
                    }
                    ///////////////////////////////////////////////////////
                    // Add the flash calls for this marker to the DOM:   //
                    ///////////////////////////////////////////////////////    
                    // -----------------------------------------------------
                    // floidMapQuestMapsMarkerSetClickable:
                    // -----------------------------------------------------
                    var floidMapQuestMapsMarkerSetClickableFunctionName                 = "floidMapMarkerSetClickable_" + mapId + "_" + markerId;
                    this.parent[floidMapQuestMapsMarkerSetClickableFunctionName]        = makeFloidMapQuestMapsMarkerSetClickableFunction(marker, markerId);    
                    // -----------------------------------------------------
                    // floidMapQuestMapsMarkerSetDraggable:
                    // -----------------------------------------------------
                    var floidMapQuestMapsMarkerSetDraggableFunctionName                 = "floidMapMarkerSetDraggable_" + mapId + "_" + markerId;
                    this.parent[floidMapQuestMapsMarkerSetDraggableFunctionName]        = makeFloidMapQuestMapsMarkerSetDraggableFunction(marker, markerId);
                    // -----------------------------------------------------
                    // floidMapQuestMapsMarkerRequestElevation:
                    // -----------------------------------------------------
                    var floidMapQuestMapsMarkerRequestElevationFunctionName             = "floidMapMarkerRequestElevation_" + mapId + "_" + markerId;
                    this.parent[floidMapQuestMapsMarkerRequestElevationFunctionName]    = makeFloidMapQuestMapsMarkerRequestElevationFunction(marker, markerId);
                    // -----------------------------------------------------
                    // floidMapQuestMapsMarkerSetIconString:
                    // -----------------------------------------------------
                    var floidMapQuestMapsMarkerSetIconStringFunctionName                = "floidMapMarkerSetIconString_" + mapId + "_" + markerId;
                    this.parent[floidMapQuestMapsMarkerSetIconStringFunctionName]       = makeFloidMapQuestMapsMarkerSetIconStringFunction(marker, markerId);
                    // -----------------------------------------------------
                    // floidMapQuestMapsMarkerSetIconShadowString:
                    // -----------------------------------------------------
                    var floidMapQuestMapsMarkerSetIconShadowStringFunctionName          = "floidMapMarkerSetIconShadowString_" + mapId + "_" + markerId;
                    this.parent[floidMapQuestMapsMarkerSetIconShadowStringFunctionName] = makeFloidMapQuestMapsMarkerSetIconShadowStringFunction(marker, markerId);
                    // ------------------------------
                    // floidMapQuestMapsRemoveMarker:
                    // ------------------------------
                    var floidMapQuestMapsRemoveMarkerFunctionName                       = "floidMapRemoveMarker_" + mapId + "_" + markerId;
                    this.parent[floidMapQuestMapsRemoveMarkerFunctionName]              = makeFloidMapQuestMapsRemoveMarkerFunction(marker, markerId);
                }
                // ----- LINES -----
                // -----------------
                // createNewLine:
                // -----------------
                function createNewLine(lineId, startLat, startLng, endLat, endLng, a, r, g, b, w)
                {
                    var newColorAlpha = a/255.0;
                    var newColor      = rgbToHex(r, g, b);
                    var line          = new MQA.LineOverlay();
                    line.setShapePoints([startLat, startLng, endLat, endLng]);
                    line.updateProperties( {color: newColor, colorAlpha: newColorAlpha, borderWidth: w});
                    map.addShape(line);
                    //////////////////////////////////////////////
                    // Line listeners that call back to flash:  //
                    //////////////////////////////////////////////
                    // ----------------------------------------------------
                    // OK, here we want to add the listeners for this line:
                    // ----------------------------------------------------
                    // Default is no listeners for this line:
                    //***********************************//
                    //***********************************//
                    // Calls from Flash to the line:     //
                    //***********************************//
                    //***********************************//
                    /////////////////////////////////////////////////
                    // Function creators for flash calls to line:  //
                    /////////////////////////////////////////////////
                    // -----------------------------------------------
                    // floidMapQuestMapsRemoveLine: [function creator]
                    // -----------------------------------------------
                    function makeFloidMapQuestMapsRemoveLineFunction(line, lineId)
                    {
                        return function()
                        {
                            log("Removing line.");
                            try
                            {
                                // Remove the line:
                                map.removeShape(line);
                                // Remove the globally bound functions:
                                // - empty
                                // Don't forget me!
                                delete this.parent[floidMapQuestMapsRemoveLineFunctionName];
                            }
                            catch(err)
                            {
                                log("floidMapQuestMapsRemoveMarker: error " + err);
                            }
                            log("Done removing line.");
                        }
                    }
                    // -----------------------------------------------
                    // floidMapQuestMapsSetLineColor: [function creator]
                    // -----------------------------------------------
                    function makeFloidMapQuestMapsSetLineColorFunction(line, lineId)
                    {
                        return function(a, r, g, b, w)
                        {
                            var newColorAlpha = a/255.0;
                            var newColor      = rgbToHex(r, g, b);
                            log("Changing line color: " + newColor);
                            try
                            {
                                line.updateProperties( {color: newColor, colorAlpha: newColorAlpha, borderWidth: w});
                            }
                            catch(err)
                            {
                                log("floidMapQuestMapsSetLineColor: error " + err);
                            }
                            log("Done setting line color.");
                        }
                    }
                    // ---------------------------------------------
                    // floidMapQuestMapsMoveLine: [function creator]
                    // ---------------------------------------------
                    function makeFloidMapQuestMapsMoveLineFunction(line, lineId)
                    {
                        return function(startLat, startLng, endLat, endLng)
                        {
                            log("Moving line [" + lineId + "] to: " + startLat + " " + startLng + " -> " + endLat + " " + endLng);
                            try
                            {
                                line.setShapePoints([startLat, startLng, endLat, endLng]);
                            }
                            catch(err)
                            {
                                log("floidMapQuestMapsMoveLine: error " + err);
                            }
                            log("Done moving line.");
                        }
                    }
                    /////////////////////////////////////////////////////
                    // Add the flash calls for this line to the DOM:   //
                    /////////////////////////////////////////////////////
                    // -----------------------------------------------------
                    // floidMapQuestMapsRemoveLineFunction:
                    // -----------------------------------------------------
                    var floidMapQuestMapsRemoveLineFunctionName                   = "floidMapRemoveLine_" + mapId + "_" + lineId;
                    this.parent[floidMapQuestMapsRemoveLineFunctionName]          = makeFloidMapQuestMapsRemoveLineFunction(line, lineId);    
                    // -----------------------------------------------------
                    // floidMapQuestMapsSetLineColorFunction:
                    // -----------------------------------------------------
                    var floidMapQuestMapsSetLineColorFunctionName                  = "floidMapSetLineColor_" + mapId + "_" + lineId;
                    this.parent[floidMapQuestMapsSetLineColorFunctionName]         = makeFloidMapQuestMapsSetLineColorFunction(line, lineId);    
                    // -----------------------------------------------------
                    // floidMapQuestMapsMoveLineFunction:
                    // -----------------------------------------------------
                    var floidMapQuestMapsMoveLineFunctionName                      = "floidMapMoveLine__" + mapId + "_" + lineId;
                    this.parent[floidMapQuestMapsMoveLineFunctionName]             = makeFloidMapQuestMapsMoveLineFunction(line, lineId);    
                }
                // ------ Paths -------
                // --------------------
                // getPathMaxElevation:
                // --------------------
                function getPathMaxElevation(lineId, startLat, startLng, endLat, endLng, maxSamples, requestedPathDistanceInMeters, errorElevation, warningElevation, actualSamples, actualPathDistanceInMeters)
                {
                    var sampleLocations = calculateSamples(startLat, startLng, endLat, endLng, actualSamples);
                    // OK, make an array of sample points to test:
                    var samplePositions = [];
                    for(var i=0; i<sampleLocations.length/2; ++i)
                    {
                        samplePositions.push(sampleLocations[i*2], sampleLocations[i*2+1]);
                    }
                    // Make elevation request object:
                    var elevationRequestObject = {
                                                     'unit'            : 'm',
                                                     'latLngCollection': samplePositions
                                                 };
                    // Convert to JSON:
                    var elevationRequestJSONString = JSON.stringify(elevationRequestObject);
                    log("Elevation JSON String: " + elevationRequestJSONString);
                    var mapQuestElevationUrl = "http://open.mapquestapi.com/elevation/v1/profile?outFormat=json&json="+elevationRequestJSONString+"&callback=?";
                    $.ajax({
                               url:        mapQuestElevationUrl,
                               dataType:   'json',
                               type:       'GET',
                               contentType:'json',
                               crossDomain:true,
                               success:    function(data) {
                                                              var errorFlag    = true;
                                                              var maxElevation = -100000;
                                                              log( data );
                                                              try
                                                              {
                                                                  if(data.elevationProfile.length >0)
                                                                  {
                                                                      maxElevation = data.elevationProfile[0].height;
                                                                      errorFlag    = false;
                                                                      for(var i=0; i<data.elevationProfile.length; ++i)
                                                                      {
                                                                          var sampleElevation = data.elevationProfile[i].height;
                                                                          if(sampleElevation > maxElevation) maxElevation = sampleElevation;
                                                                      }
                                                                      log("Max elevation of path: " + maxElevation);
                                                                      // call back into flash :)
                                                                      swfObject["floidMapPathMaxElevationCallBack_" + mapId](lineId, startLat, startLng, endLat, endLng, maxSamples, requestedPathDistanceInMeters, errorElevation, warningElevation, maxElevation, actualSamples, actualPathDistanceInMeters, errorFlag);
                                                                      log("elevation callback done:");
                                                                  }
                                                                  else
                                                                  {
                                                                      // call back into flash :)
                                                                      swfObject["floidMapPathMaxElevationCallBack_" + mapId](lineId, startLat, startLng, endLat, endLng, maxSamples, requestedPathDistanceInMeters, errorElevation, warningElevation, maxElevation, actualSamples, actualPathDistanceInMeters, errorFlag);
                                                                  }
                                                              }
                                                              catch(err)
                                                              {
                                                                  swfObject["floidMapPathMaxElevationCallBack_" + mapId](lineId, startLat, startLng, endLat, endLng, maxSamples, requestedPathDistanceInMeters, errorElevation, warningElevation, maxElevation, actualSamples, actualPathDistanceInMeters, errorFlag);
                                                              }
                                                          },
                               error:      function(data) {
                                                              log( 'getMaxPathElevation: error occurred - ' + data );
                                                              var errorFlag    = true;
                                                              var maxElevation = -100000;
                                                              // call back into flash :)
                                                              swfObject["floidMapPathMaxElevationCallBack_" + mapId](lineId, startLat, startLng, endLat, endLng, maxSamples, requestedPathDistanceInMeters, errorElevation, warningElevation, maxElevation, actualSamples, actualPathDistanceInMeters, errorFlag);
                                                          }
                           });
                    log("getPathMaxElevation: " + lineId + " sent");
                }            
                // OK, the map is fully initialized - call back into flash:
                swfObject["floidMapInitialized_" + mapId]();
            }
            function finalize()
            {
                // Remove global map functions - TODO: remove remaining marker & line functions
                try
                {
                    delete this.parent[floidMapQuestMapsCreateNewMarkerFunctionName];
                    delete this.parent[floidMapQuestMapsCreateNewLineFunctionName];
                    delete this.parent[floidMapQuestMapsAddDoubleClickListenerFunctionName];
                    delete this.parent[floidMapQuestMapsRemoveDoubleClickListenerFunctionName];
                    delete this.parent[floidMapQuestMapsGetPathMaxElevationFunctionName];
                }
                catch(err)
                {
                    log("Removing map methods error: " + err);
                }
                if(swfObject != null)
                {
                    // call back into flash :)
                    swfObject["floidMapFrameUnloaded_" + mapId]();
                }
            }
        </script>
      </head>
      <body onload="initialize()" onunload="finalize()">
      <!-- Note that with height and width 100% below, the MapQuest map was not inset right -->
        <div id="map_canvas" style="width:400px; height:400px;"></div>
      </body>
    </html>